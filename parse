#!/usr/bin/env bash

./deps yq jq awk || exit 1

dir=".var/${1:-$(cat)}"

# Make sure it's a valid directory
if [ ! -d "$dir" ]; then
  echo "Not a valid directory"
  exit 1
fi

# Get the list of markdown files in the directory
files=$(find "$dir" -type f -name "*.md")

# Exit if no markdown files are found
if [ -z "$files" ]; then
  echo "No markdown files found"
  exit 0
fi

# Initialize an empty JSON array
json_array="[]"

# Iterate through each file
for file in $files; do
  # Extract the frontmatter between the --- markers
  frontmatter=$(sed -n '/^---$/,/^---$/p' "$file" | sed '1d;$d')

  # Use yq to convert the frontmatter to JSON
  json=$(echo "$frontmatter" | yq e -o=json '.')

  # Extract the body (everything after the second --- marker)
  body=$(sed -n '/^---$/,/^---$/!p' "$file")

  # Add the encoded body and filepath as properties to the JSON object
  final_json=$(echo "$json" | jq --arg filepath "$file" --arg contents "$body" '. + {filepath: $filepath, contents: $contents}')

  # Append the JSON object to the JSON array
  json_array=$(echo "$json_array" | jq --argjson final_json "$final_json" '. + [$final_json]')
done

# Output the final JSON array
echo "$json_array" | jq
