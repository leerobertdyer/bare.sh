#!/usr/bin/env bash
set -e
BARE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.."; pwd)" && cd "$BARE_DIR" && export BARE_DIR

# check for ~/.barerc file
[[ ! -f $HOME/.barerc ]] && {
	touch "$HOME"/.barerc
} || source "$HOME"/.barerc
chmod 600 "$HOME"/.barerc # make sure it's only readable and writable by the user

# Find a port for us to use with the web server
BARE_PORT=8080
while lsof -i :$BARE_PORT > /dev/null; do
	BARE_PORT=$((BARE_PORT + 1))
done
export BARE_PORT

# Detect which OS we are using
case "$(uname -s)" in
	Linux*) export BARE_OS=linux ;;
	Darwin*) export BARE_OS=mac ;;
	*) echo "Bare only supports Linux and macOS" && exit 1 ;;
esac

# If lib/www/sqlpage/sqlpage.json doesn't exist, create it with default values
if [[ ! -f lib/www/sqlpage/sqlpage.json ]]; then
	echo "{\"allow_exec\": true, \"port\": $BARE_PORT}" > lib/www/sqlpage/sqlpage.json
fi

# Set up port and allow_exec in sqlpage.json
if [[ ! -s lib/www/sqlpage/sqlpage.json ]]; then
	echo "{\"allow_exec\": true, \"port\": $BARE_PORT}" > lib/www/sqlpage/sqlpage.json
else
	jq --arg BARE_PORT "$BARE_PORT" '.allow_exec = true | .port = ($BARE_PORT | tonumber)' lib/www/sqlpage/sqlpage.json > tmp.$$.json && mv tmp.$$.json lib/www/sqlpage/sqlpage.json
fi

# Set up nb to use the correct directory
export BARE_NOTES_DIR="$BARE_DIR"/var/.nb
export NB_DIR="$BARE_NOTES_DIR"

source "$BARE_DIR"/lib/colors
source "$BARE_DIR"/lib/deps

# make sure git name and git email are set up for notes (git global settings)
[[ -z "$(git config --global user.name)" ]] && {
	read -rp "Please enter your name (for use with note authoring): " git_name
	git config --global user.name "$git_name"
}

[[ -z "$(git config --global user.email)" ]] && {
	read -rp "Please enter your email (for use with note authoring): " git_email
	git config --global user.email "$git_email"
}

mkdir -p "$BARE_NOTES_DIR/scripts"
mkdir -p "$BARE_NOTES_DIR/research"
mkdir -p "$BARE_NOTES_DIR/imports"
mkdir -p "$BARE_NOTES_DIR/images"



# =============================================================================

# Common Functions

inspect() {
	doc="$1"
	export doc
	if [[ $2 == "--inspect" ]]; then
		b/inspect "$2" && exit 0
	fi
}